<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Área Personal</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <style>
            table, th, td {
                border: 1px solid black;
                border-collapse: collapse; /* Evita bordes dobles */
            }
            th, td {
                padding: 10px;
                text-align: center;
            }
            th {
                background-color: darkgray;
            }
            div{
                margin: 20px;
                padding: 20px;
            }
            /* Estilos para el modal */
            .modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 600px;
                padding: 20px;
                background: white;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                border-radius: 12px;
                z-index: 1000; /* Para estar por encima del contenido */
                display: none; /* Oculto por defecto */
            }

            /* Fondo oscuro detrás del modal */
            .overlay {
                position: fixed;
                margin: 0px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999; /* Debajo del modal, pero por encima del resto */
                display: none;
            }
        </style>
    </head>
    <body>
        <div>
            <h1 id="bienvenida">Cargando...</h1>
            <h2 id="datos-usuario">Cargando datos del usuario...</h2>
            <div id="div-encargado" style="display: none; background-color: lightgray">
                <div style="background-color: darkgray">
                    <h3>Crear nuevo usuario</h3>
                    <p>Crea una nueva cuenta de encargado o empleado.</p>
                    <form id="form-crear">
                        <label for="usuario">Usuario:</label>
                        <input type="text" id="usuario" name="usuario" required>

                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" name="password" required>

                        <label for="passwordr">Repetir contraseña:</label>
                        <input type="password" id="passwordr" name="passwordr" required>

                        <select id="rol" required size="2">
                            <option value="Empleado">Empleado</option>
                            <option value="Encargado">Encargado</option>
                        </select> 

                        <button type="submit">Crear usuario</button>
                    </form>
                    <p id="error-message" style="color: red;"></p> <!-- Mensaje de error -->
                    <p id="success-message" style="color: green;"></p> <!-- Mensaje de exito -->
                </div>
                <div style="background-color: darkgray">
                    <h3>Descargar datos de todos los empleados</h3>
                    <p>Descarga archivos con los datos de registros de todos los empleados en el rango de fechas seleccionado.</p>
                    <form id="form-descarga" action="TryDescargarRegistrosZip" method="GET">
                        <label for="fecha-inicio">Fecha de inicio: </label>
                        <input type="date" id="fecha-inicio" name="fechaInicio" required>
                        <label for="fecha-fin">Fecha de fin: </label>
                        <input type="date" id="fecha-fin" name="fechaFin" required>
                        <button type="submit">Descargar datos</button>
                    </form>
                </div>
                <div style="background-color: darkgray">
                    <h3>Consulta de datos recientes</h3>
                    <p>Consulta en una tabla los últimos registros de un empleado y descarga sus datos.</p>
                    <form id="form-consulta">
                        <label for="selector-empleados">Selecciona un empleado: </label>
                        <select id="selector-empleados">
                        </select>
                        <button type="submit">Consultar empleado</button>
                    </form>
                </div>
            </div>
            <div id = "div-empleado" style="display: none; background-color: lightgray">
                <form id="form-registro">
                    <h3 id="estado-actual">Cargando estado...</h3>
                    <button type="submit">Fichar</button>
                </form>
                <p id="error-registro" style="color: red;"></p> <!-- Mensaje de error -->
            </div>
            <div id = "div-tabla" style="background-color: lightgray">
                <h2 id="titulo-tabla">Últimos registros</h2>
                <p id="error-consulta" style="color: red;"></p> <!-- Mensaje de error -->
                <table id="tabla">
                    <thead>
                        <tr>
                            <th>Dia</th>
                            <th>Hora</th>
                            <th>Tipo</th>
                            <th>Horas acumuladas</th>
                            <th>Notas</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Las filas se agregarán aquí -->
                    </tbody>
                </table>
                <button id="descargar-datos">Descargar todos los datos</button>
            </div>
            <button id="cambiar-password">Cambiar contraseña</button>
            <button id="logout">Cerrar sesión</button>
        </div>

        <div id="modal" class="modal">
            <p id="modal-texto"></p>
            <form id="form-nota">
                <input type="text" id="texto-nota" name="texto-nota" placeholder="Escribe una nota..." required>
                <button type="submit" id="submit-nota" name="0">Publicar nota</button>
            </form>
            <p id="error-nota" style="color: red;"></p> <!-- Mensaje de error -->
            <button onclick="cerrarModal()">Cerrar</button>
        </div>

        <div id="overlay" class="overlay" onclick="cerrarModal()"></div>
        <script>
            $(document).ready(function () {
                // Obtiene los datos del usuario desde el servlet
                $.ajax({
                    url: "GetUser", // URL del servlet que devuelve los datos del usuario
                    type: "GET",
                    success: function (response) {
                        // Muestra los datos del usuario
                        try {
                            $("#bienvenida").text("Bienvenido/a, " + response.usuario + "!");
                            $("#datos-usuario").text("Rol: " + response.rol);
                            if (response.rol === "empleado") {
                                let divempleado = document.getElementById("div-empleado");
                                divempleado.style.display = "block";
                                $("#estado-actual").text("Estado actual: " + response.estado);
                                updatetabla(response.datos); //Si es empleado, devuelve una lista con sus registros para cargar en la tabla              
                                let option = document.createElement('option');
                                option.value = response.usuario;
                                option.text = response.usuario;
                                document.getElementById("selector-empleados").appendChild(option);
                            } else if (response.rol === "encargado") {
                                let divencargado = document.getElementById("div-encargado");
                                divencargado.style.display = "block";
                                updateselector(response.datos);//Si es encargado, devuelve una lista con los nombres de empleados para cargar en el selector
                            }
                        } catch (error) {
                            $("#bienvenida").text("Error al obtener los datos del usuario.");
                            $("#datos-usuario").text("Es posible que no tengas la sesión iniciada. Haz clic en cerrar sesión y vuelve a introducir tus credenciales.");
                        }
                    },
                    error: function () {
                        $("#bienvenida").text("Error al cargar los datos del usuario.");
                        $("#datos-usuario").text("Es posible que no tengas la sesión iniciada. Haz clic en cerrar sesión y vuelve a introducir tus credenciales.");
                    }
                });
            });

            function updatetabla(listaregistros) {
                let tabla = document.getElementById("tabla").getElementsByTagName("tbody")[0];
                tabla.innerHTML = "";
                listaregistros.forEach(registro => {
                    let fila = tabla.insertRow();
                    let celdadia = fila.insertCell(0);
                    let celdahora = fila.insertCell(1);
                    let celdatipo = fila.insertCell(2);
                    let celdahoras = fila.insertCell(3);
                    let celdanotas = fila.insertCell(4);
                    celdadia.textContent = registro.fecha;
                    celdahora.textContent = registro.hora;
                    celdatipo.textContent = registro.tipo;
                    celdahoras.textContent = formatMinutesToHHMM(registro.minutosAcumulados);
                    const botonnotas = document.createElement("button");
                    botonnotas.textContent = "Ver notas";
                    botonnotas.id = registro.id;
                    botonnotas.onclick = function () {
                        abrirModal(botonnotas.id);
                    };
                    celdanotas.appendChild(botonnotas);
                });
            }

            function formatMinutesToHHMM(totalMinutes) {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                // Aseguramos que siempre haya dos dígitos en los minutos
                return `${hours}:${minutes.toString().padStart(2, '0')}`;
            }

            function updateselector(listaempleados) {
                let selector = document.getElementById("selector-empleados");
                listaempleados.forEach(empleado => {
                    let option = document.createElement('option');
                    option.value = empleado;
                    option.text = empleado;
                    selector.appendChild(option);
                });
            }

            function abrirModal(id) {
                // Envía los datos al servlet usando AJAX
                $.ajax({
                    url: "TryGetNotas", // URL del servlet
                    type: "GET",
                    data: {idRegistro: id},
                    success: function (response) {
                        let texto = "";
                        if (response.estado === "correcto") {
                            // Actualiza el texto con las notas
                            response.notas.forEach(nota => {
                                texto += nota.autor + " (" + nota.fecha + " a las " + nota.hora + "): " + nota.texto + "<br>";
                            });
                        } else if (response.estado === "no_autorizado") {
                            // Error de permisos
                            texto = "Error. Tu usuario no está autorizado para esta acción.";
                        } else {
                            // Error desconocido
                            texto = "Error desconocido. Intentelo de nuevo más tarde.";
                        }
                        document.getElementById("modal-texto").innerHTML = texto; //Sustituir por texto de notas
                        document.getElementById("submit-nota").name = id; // Pone el id en el boton de crear nota
                        document.getElementById("error-nota").textContent = ""; // Reinicia el mensaje de error
                        document.getElementById("texto-nota").value = ""; // Reinicia la textbox
                        document.getElementById("modal").style.display = "block";
                        document.getElementById("overlay").style.display = "block";
                    },
                    error: function () {
                        $("#error-consulta").text("Error al contactar con el servidor. Inténtelo de nuevo más tarde.");
                    }
                });
            }

            function cerrarModal() {
                document.getElementById("modal").style.display = "none";
                document.getElementById("overlay").style.display = "none";
            }

            $("#form-crear").submit(function (event) {
                event.preventDefault(); // Evita que el formulario se envíe de manera tradicional

                const usuario = $("#usuario").val();
                const password = $("#password").val();
                const passwordr = $("#passwordr").val();
                const rol = $("#rol").val();
                $("#error-message").text("");
                $("#success-message").text("");
                if (password === passwordr) {
                    if (usuario.length <= 60 && password.length <= 50) {

                        // Envía los datos al servlet usando AJAX
                        $.ajax({
                            url: "CrearUsuario", // URL del servlet
                            type: "POST",
                            data: {usuario: usuario, password: password, rol: rol},
                            success: function (response) {
                                if (response === "correcto") {
                                    // Muestra mensaje de éxito
                                    $("#success-message").text("Usuario creado correctamente.");
                                } else if (response === "no_autorizado") {
                                    // Muestra el mensaje de error debajo del formulario
                                    $("#error-message").text("Error. Tu usuario no está autorizado para esta acción.");
                                } else if (response === "incorrecto") {
                                    // Muestra el mensaje de error debajo del formulario
                                    $("#error-message").text("Error. Ya existe un usuario con ese nombre");
                                } else {
                                    // Muestra el mensaje de error debajo del formulario
                                    $("#error-message").text("Error en el servidor. Inténtelo de nuevo más tarde.");
                                }
                            },
                            error: function () {
                                $("#error-message").text("Error al contactar con el servidor. Inténtelo de nuevo más tarde.");
                            }
                        });
                    } else
                        $("#error-message").text("Usuario o contraseña demasiado largos. Maximo 60 caracteres para usuario y 50 para contraseña");
                } else
                    $("#error-message").text("Las contraseñas introducidas no coinciden.");
            });

            $("#form-consulta").submit(function (event) { // Manejo del formulario de consulta de registros
                event.preventDefault(); // Evita que el formulario se envíe de manera tradicional
                // Envía los datos al servlet usando AJAX
                $.ajax({
                    url: "TryGetRegistros", // URL del servlet
                    type: "GET",
                    data: {usuario: $("#selector-empleados").val()},
                    success: function (response) {
                        if (response.estado === "correcto") {
                            // Actualiza la tabla con los registros devueltos
                            updatetabla(response.registros);
                        } else if (response.estado === "no_autorizado") {
                            // Muestra el mensaje de error debajo del formulario
                            $("#error-consulta").text("Error. Tu usuario no está autorizado para esta acción.");
                        } else {
                            // Muestra el mensaje de error debajo del formulario
                            $("#error-consulta").text("Error desconocido. Intentelo de nuevo más tarde.");
                        }
                    },
                    error: function () {
                        $("#error-consulta").text("Error al contactar con el servidor. Inténtelo de nuevo más tarde.");
                    }
                });
            });

            $("#form-registro").submit(function (event) { // Manejo del formulario de fichar
                event.preventDefault(); // Evita que el formulario se envíe de manera tradicional
                // Envía los datos al servlet usando AJAX
                $.ajax({
                    url: "TryCrearRegistro", // URL del servlet
                    type: "GET",
                    success: function (response) {
                        if (response === "correcto") {
                            // Actualiza la pagina para mostrar el nuevo estado y el registro en la tabla
                            window.location.href = "areapersonal.html";
                        } else if (response === "no_autorizado") {
                            // Muestra el mensaje de error debajo del formulario
                            $("#error-registro").text("Error. Tu usuario no está autorizado para esta acción.");
                        } else {
                            // Muestra el mensaje de error debajo del formulario
                            $("#error-registro").text("Error desconocido. Intentelo de nuevo más tarde.");
                        }
                    },
                    error: function () {
                        $("#error-registro").text("Error al contactar con el servidor. Inténtelo de nuevo más tarde.");
                    }
                });
            });

            $("#form-nota").submit(function (event) { // Manejo del formulario de publicar nota
                event.preventDefault(); // Evita que el formulario se envíe de manera tradicional
                const id = document.getElementById("submit-nota").name;
                const texto = $("#texto-nota").val();
                if (texto.length <= 255) {
                    // Envía los datos al servlet usando AJAX
                    $.ajax({
                        url: "TryCrearNota", // URL del servlet
                        type: "POST",
                        data: {idRegistro: id, textoNota: texto},
                        success: function (response) {
                            if (response === "correcto") {
                                // Recarga el modal para mostrar la nueva nota
                                abrirModal(id);
                            } else if (response === "no_autorizado") {
                                // Muestra el mensaje de error debajo del formulario
                                $("#error-nota").text("Error. Tu usuario no está autorizado para esta acción.");
                            } else {
                                // Muestra el mensaje de error debajo del formulario
                                $("#error-nota").text("Error desconocido. Intentelo de nuevo más tarde.");
                            }
                        },
                        error: function () {
                            $("#error-nota").text("Error al contactar con el servidor. Inténtelo de nuevo más tarde.");
                        }
                    });
                } else {
                    $("#error-nota").text("La nota no puede tener más de 255 caracteres.");
                }
            });

            $("#descargar-datos").on("click", function (e) {
                e.preventDefault();
                const usuario = $("#selector-empleados").val();
                window.location.href = "TryDescargarRegistros?usuario=" + encodeURIComponent(usuario);
            });

            $("#cambiar-password").on("click", function (e) {
                e.preventDefault(); // Evita que el enlace redirija directamente
                // Realiza una solicitud AJAX para cerrar la sesión
                window.location.href = "cambiarpw.html";
            }
            );

            $("#logout").on("click", function (e) {
                e.preventDefault(); // Evita que el enlace redirija directamente
                // Realiza una solicitud AJAX para cerrar la sesión
                $.ajax({
                    url: "Logout", // URL del servlet que maneja el cierre de sesión
                    type: "POST",
                    success: function () {
                        window.location.href = "index.html";
                    },
                    error: function () {
                        alert("Error al intentar cerrar la sesión.");
                    }
                });
            }
            );
        </script>
    </body>
</html>